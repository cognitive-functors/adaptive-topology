# MASTm: Мультимасштабный адаптивный спектральный мета-солвер для задачи коммивояжёра

## Координатно-ориентированный мета-солвер для TSP

MASTm -- солвер задачи коммивояжёра (Travelling Salesman Problem, TSP),
использующий отпечаток (fingerprint) экземпляра задачи для адаптивного выбора
стратегии оптимизации. Масштабируется до N=200K+ городов, потребляя всего
~230 МБ ОЗУ за счёт того, что полная матрица расстояний N x N никогда не
материализуется (при N=100K она заняла бы 80 ГБ).

**Авторы:** Илья Селютин, Николай Ковалёв

---

### Быстрый старт (3 команды)

```bash
pip install -r requirements.txt

# Установить PYTHONPATH на корень пакета, чтобы импорты `src.core.*` работали
PYTHONPATH=$(pwd) python3 scripts/run_benchmark_v6.py \
    --instances fl3795 --budget 120 --runs 1

# Ожидаемый вывод (бюджет 120с, один запуск):
#   fl3795 (N=3795, optimal=28772, budget=120s, 1 runs)
#   run 1: length=28885, gap=0.39%, time=120s
```

**Важно.** Скрипт бенчмарка загружает файлы `.tsp` по имени экземпляра из
каталога, заданного переменной `TSP_DIR` (строка 74 файла `run_benchmark_v6.py`).
Перед запуском укажите путь к вашему локальному каталогу `benchmarks/`:

```python
# В файле scripts/run_benchmark_v6.py измените:
TSP_DIR = Path('/path/to/your/benchmarks')
# На:
TSP_DIR = Path(__file__).resolve().parent.parent / 'benchmarks'
```

**Примечание о модуле fingerprint.** Солвер импортирует
`src.core.fingerprint` (снятие отпечатка экземпляра и маршрутизация стратегий).
Этот модуль включён в дистрибутив по пути `src/core/fingerprint.py`.

---

### Что такое MASTm?

MASTm рассматривает TSP не как единую задачу оптимизации, а как семейство
структурно различных задач. Перед решением вычисляется топологический отпечаток
(topological fingerprint) экземпляра -- измеряются однородность плотности
(cv_nn_dist), спектральный зазор (spectral gap, декомпозируемость), модулярность
Ньюмана (Newman modularity, кластеризуемость) и соотношение сторон (aspect ratio).
Маршрутизатор стратегий (strategy router) затем выбирает:

- Использовать ли иерархическую декомпозицию или решать задачу напрямую
- Спектральный или пространственный режим декомпозиции
- Бюджет листовых подзадач, интенсивность V-цикла, глубину поиска LK
- Применять ли EAX-кроссовер (Edge Assembly Crossover) на этапе финальной полировки

Такая адаптивная маршрутизация по экземплярам даёт улучшение зазора (gap) на
15--30% по сравнению с любой фиксированной стратегией.

**Ключевые характеристики:**

| Свойство            | Значение                                         |
|---------------------|--------------------------------------------------|
| Память при N=100K   | ~230 МБ (координаты + k-NN граф + тур)           |
| Память наивно       | ~80 ГБ (полная матрица расстояний)               |
| Параллелизм         | multiprocessing (fork), до 12 рабочих процессов  |
| Локальный поиск     | Numba JIT: 2-opt, 3-opt, or-opt, LK-DLB         |
| Кроссовер           | EAX (Edge Assembly Crossover) для N>5K           |
| Декомпозиция        | Рекурсивная спектральная / пространственная (адаптивная) |

---

### Основные результаты

Лучшие зазоры на экземплярах TSPLIB (бюджет 120с, лучший из 3 запусков, M3 Max):

| Экземпляр | N      | Оптимум   | Лучший gap % | Средний gap % |
|------------|--------|-----------|--------------|---------------|
| berlin52   |     52 |     7,542 |        0.031 |         0.031 |
| kroA100    |    100 |    21,282 |        0.016 |         0.016 |
| ch150      |    150 |     6,528 |        0.044 |         0.044 |
| pcb442     |    442 |    50,778 |        0.27  |         0.49  |
| dsj1000    |  1,000 | 18,659,688|       0.16  |         0.38  |
| pcb3038    |  3,038 |   137,694 |        1.18  |         1.27  |
| fl3795     |  3,795 |    28,772 |        0.39  |         1.22  |
| fnl4461    |  4,461 |   182,566 |        1.78  |         2.05  |
| rl5915     |  5,915 |   565,530 |        1.20  |         1.56  |
| pla7397    |  7,397 | 23,260,728|       2.21  |         2.52  |
| d15112     | 15,112 | 1,573,084 |        3.54  |         3.64  |

Расширенные запуски с бюджетом 300с и подстройкой параметров достигают
fl3795 0.22% и rl5915 1.20%.

---

### Архитектура (6-фазный конвейер)

```
Вход: coords[N, 2]
         |
         v
  Фаза 0: DistanceOracle             ~2% времени
  KDTree k-NN (k=20), разреженный лапласиан
         |
         v
  Фаза 0a: Fingerprint + Route       ~1% времени
  cv_nn_dist, spectral_gap, modularity -> SolverConfig
         |
         v
  Фаза 1: Рекурсивная декомпозиция   ~3% времени
  Спектральная бисекция / квадрисекция -> листовые узлы (N<=1500)
         |
         v
  Фаза 2: Параллельная оптимизация листьев  ~50% времени
  На каждом листе: multi-start NN -> 2-opt -> or-opt/3-opt -> ILS (DB+LK)
  12 рабочих процессов через multiprocessing (fork)
         |
         v
  Фаза 3: Восходящая сшивка          ~10% времени
  k-NN межлистовые рёбра -> мета-TSP -> полировка границ
  Метрика качества сшивки определяет бюджет V-цикла
         |
         v
  Фаза 4: V-цикл уточнения           ~25% времени
  Скользящее окно (segment_size адаптивный), or-opt + 3-opt + LK
  Фокус на границах: стрессовые рёбра из точек сшивки
         |
         v
  Фаза 5: Глобальная полировка        ~10% времени
  Подфаза A: ILS (double_bridge + LK-DLB), сбор разнообразных туров
  Подфаза B: EAX популяционная оптимизация (для N>5K)
         |
         v
Выход: {tour, length, phases, time_total}
```

Для малых экземпляров (N<3000, равномерное распределение) маршрутизатор может
пропустить декомпозицию, выполняя напрямую NN + LK + ILS + EAX.

---

### Запуск бенчмарков

**Один экземпляр:**

```bash
PYTHONPATH=$(pwd) python3 scripts/run_benchmark_v6.py \
    --instances fl3795 --budget 120 --runs 3
```

**Несколько экземпляров:**

```bash
PYTHONPATH=$(pwd) python3 scripts/run_benchmark_v6.py \
    --instances eil51,kroA100,pcb442,fl3795,rl5915 --budget 120 --runs 3
```

**Полный набор бенчмарков (малые + средние + крупные):**

```bash
PYTHONPATH=$(pwd) python3 scripts/run_benchmark_v6.py --budget 120 --runs 3
```

**Полный набор включая сверхкрупные (100K+):**

```bash
PYTHONPATH=$(pwd) python3 scripts/run_benchmark_v6.py --full --budget 300 --runs 1
```

**Анализ отпечатков:**

```bash
PYTHONPATH=$(pwd) python3 scripts/fingerprint_analysis.py --mode fingerprint
```

**Формат вывода.** Результаты сохраняются в формате JSON в каталог `results/`.
Каждая запись содержит статистику по экземпляру: N, оптимальное значение, бюджет,
зазоры по каждому запуску, средний/минимальный/стд зазор, время выполнения и
метаданные по фазам (stitch_ratio, улучшение V-цикла).

**Подробный режим.** Добавьте `--verbose` для вывода прогресса по фазам:

```
[v5] Phase 0: Building DistanceOracle (k=20, adaptive=True)...
[v5] Phase 0a: CLUSTERED strategy (cv_nn=0.891, Q=0.52) -> decompose+spectral
[v5] Phase 1: Spectral decomposition (max_leaf=1200)...
  decomposed: 6 leaves, depth=2, leaf_size=412-832
[v5] Phase 2: Optimizing 6 leaves (12 workers, budget=42s)...
[v5] Phase 3: Stitching 6 leaf tours...
  stitch quality: ratio=0.047, count=12, stress=3.2x
[v5] Phase 4: V-cycle refinement (budget=55s, fraction=75%)...
[v5] Phase 5: Global polish (budget=18s)...
[v5] DONE: length=28885, time=120.0s
```

---

### Включённые экземпляры бенчмарков

Все экземпляры взяты из TSPLIB. Файлы находятся в каталоге `benchmarks/`
в стандартном формате TSPLIB (.tsp).

| Экземпляр | N      | Оптимальное значение | Категория |
|------------|--------|----------------------|-----------|
| eil51      |     51 |                  426 | малый     |
| berlin52   |     52 |                7,542 | малый     |
| kroA100    |    100 |               21,282 | малый     |
| ch150      |    150 |                6,528 | малый     |
| pcb442     |    442 |               50,778 | малый     |
| att532     |    532 |               27,686 | малый     |
| fl1400     |  1,400 |               20,127 | средний   |
| fl3795     |  3,795 |               28,772 | средний   |
| fnl4461    |  4,461 |              182,566 | средний   |
| rl5915     |  5,915 |              565,530 | средний   |
| pla7397    |  7,397 |           23,260,728 | крупный   |
| d15112     | 15,112 |            1,573,084 | крупный   |

Дополнительные экземпляры TSPLIB (вплоть до pla85900, mona-lisa100K)
поддерживаются при размещении в каталоге benchmarks. Оптимальные значения
встроены в скрипт бенчмарка.

---

### Требования к оборудованию

**Программное обеспечение:**

- Python 3.10+ (протестировано на 3.14; версии 3.10-3.12 также работают с Numba)
- NumPy >= 1.24
- SciPy >= 1.10
- Numba >= 0.59
- tsplib95 >= 0.7
- matplotlib >= 3.7 (для визуализации анализа отпечатков)

**Примечание для macOS:** Солвер использует `multiprocessing.get_context('fork')`
для параллельной оптимизации листьев. Это корректный контекст для macOS с
Python 3.8+, где значение по умолчанию изменилось на `spawn`. Дополнительная
настройка не требуется -- это обрабатывается внутри солвера.

**Рекомендации по оборудованию:**

| Масштаб      | N          | Ядра  | ОЗУ   | Время (бюджет 120с) |
|--------------|------------|-------|-------|-----------------------|
| Малый        | < 1,000    | 4+    | 4 ГБ  | < 120с                |
| Средний      | 1K - 10K   | 8+    | 8 ГБ  | 120с                  |
| Крупный      | 10K - 50K  | 8+    | 16 ГБ | 120-300с              |
| Сверхкрупный | 50K+       | 12+   | 32 ГБ | 300-600с              |

Солвер разработан и протестирован на MacBook Pro M3 Max (12 P-ядер, 48 ГБ ОЗУ).

---

### Структура проекта

```
mast/
|-- README.md                       Этот файл (английская версия)
|-- README-ru.md                    Русская версия
|-- requirements.txt                Зависимости Python
|-- src/
|   |-- __init__.py
|   |-- core/
|       |-- __init__.py
|       |-- distance_oracle.py      KDTree k-NN, разреженный лапласиан, sub-D по запросу
|       |-- numba_sparse.py         Numba JIT: dist, NN, 2-opt, 3-opt, or-opt,
|       |                           LK-DLB, double_bridge (~1400 строк)
|       |-- hierarchy.py            Рекурсивная спектральная декомпозиция, сшивка,
|       |                           V-цикл уточнения (~1600 строк)
|       |-- eax_sparse.py           EAX-кроссовер: AB-цикл + популяционная оптимизация
|       |                           (~1300 строк)
|       |-- ultra_solver.py         Точка входа solve_v5(), 6-фазный конвейер
|       |-- hybrid_solver.py        Устаревший диспетчер (маршрутизация v4/v5)
|-- scripts/
|   |-- run_benchmark_v6.py         Основной скрипт бенчмарка
|   |-- fingerprint_analysis.py     Визуализация отпечатков + абляционный анализ
|-- benchmarks/
|   |-- eil51.tsp ... d15112.tsp    12 экземпляров TSPLIB
|-- results/
|   |-- v6_benchmark_120s.json      Полные результаты бенчмарка (120с, 3 запуска)
|   |-- v6.6_large_300s.json        Результаты расширенных запусков
|   |-- exp2_spectral_dna.json      Данные спектральных отпечатков
|   |-- ...                         Исторические результаты версий (v3-v6)
```

**Объём кодовой базы:** ~6,000 строк Python (ядро солвера), все горячие пути
на Numba JIT.

---

### Связанные публикации

Теоретические основы MASTm описаны в сопутствующей серии статей,
расположенных в `../papers/`:

- `algorithmic-topology/` -- Формальная топология пространств решений TSP
  - `00-mast-instance-adaptive-tsp.md` -- MASTm: адаптивный к экземпляру TSP
  - `01-universal-fingerprint-protocol.md` -- Универсальный протокол отпечатков
  - `02-from-cognitive-coordinates-to-combinatorial-optimization.md`
  - `03-adaptive-routing-theorem.md` -- Формальные гарантии маршрутизации
  - `04-cross-domain-evidence.md` -- Кросс-доменные приложения

- `formal-mathematics/` -- Формальные доказательства и категорно-теоретический каркас
- `fractal-c4/` -- Связь с координатной системой C4 (Z3^3)

---

### Лицензия

Исследовательский код. Свяжитесь с авторами для уточнения условий лицензирования.
